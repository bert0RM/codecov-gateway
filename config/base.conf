worker_processes ${CODECOV_GATEWAY_NGINX_PROCESSES};
error_log stderr warn;
pid /run/nginx.pid;

events {
  worker_connections  1024;
}

http {
  include /etc/nginx/mime.types;
  log_format main_timed '${DOLLAR}remote_addr - ${DOLLAR}remote_user [${DOLLAR}time_local] "${DOLLAR}request" '
                            '${DOLLAR}status ${DOLLAR}body_bytes_sent "${DOLLAR}http_referer" '
                            '"${DOLLAR}http_user_agent" "${DOLLAR}http_x_forwarded_for" '
                            '${DOLLAR}request_time ${DOLLAR}upstream_response_time ${DOLLAR}pipe ${DOLLAR}upstream_cache_status';
  client_max_body_size 100m;
  access_log /dev/stdout main_timed;
  error_log /dev/stderr notice;
  client_body_temp_path /tmp/client_temp;
  proxy_temp_path /tmp/proxy_temp_path;
  fastcgi_temp_path /tmp/fastcgi_temp;
  uwsgi_temp_path /tmp/uwsgi_temp;
  scgi_temp_path /tmp/scgi_temp;

  upstream legacy {
    server ${CODECOV_WEB_HOST}:${CODECOV_WEB_PORT};
  }
  upstream api {
    server ${CODECOV_API_HOST}:${CODECOV_API_PORT};
  }
  upstream rti {
    server ${CODECOV_RTI_HOST}:${CODECOV_RTI_PORT};
  }

  gzip on;
  gzip_proxied any;
  gzip_types text/plain application/xml text/css text/js text/xml application/x-javascript text/javascript application/json application/xml+rss;
  gzip_vary on;
  gzip_disable "msie6";

  include /etc/nginx/conf.d/codecov.conf;
}
